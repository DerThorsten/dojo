<html>
<head>

  <meta name='viewport' content='width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0' />

  <link rel="stylesheet" type="text/css" href="css/dojo.css">
  <link rel="stylesheet" type="text/css" href="css/opentip.css">

  <script type="text/javascript" src='lib/zlib.min.js'></script>
  <script type="text/javascript" src='lib/opentip-native.min.js'></script>

  <script type='text/javascript' src='dojo.js'></script>
  <script type='text/javascript' src='viewer.js'></script>
  <script type='text/javascript' src='controller.js'></script>
  <script type='text/javascript' src='camera.js'></script>
  <script type='text/javascript' src='interactor.js'></script>
  <script type='text/javascript' src='loader.js'></script>
  <script type='text/javascript' src='websocket.js'></script>
  <script type='text/javascript' src='offscreen_renderer.js'></script>
  <script type='text/javascript' src='util.js'></script>

  <!-- SHADERS -->
  <script id="fs1" type="x-shader/x-fragment">
    precision mediump float;
    precision mediump int;

    uniform sampler2D uTextureSampler;
    uniform sampler2D uColorMapSampler;
    uniform sampler2D uMergeTableKeySampler;
    uniform sampler2D uMergeTableValueSampler;
    //uniform sampler2D uTextureSampler2;
    uniform float uOpacity;
    uniform float uHighlightedId;
    uniform float uActivatedId;
    uniform float uMaxColors;
    uniform int uBorders;
    uniform int uMergeTableLength;

    const int MAX_MERGES = 1000000;

    varying vec3 vPosition;
    varying vec2 vTexturePosition;

    // convert rgba to a 32 bit value
    float unpack (vec4 value) {
      // note: little endian
      const vec4 bitShifts = vec4( (256.0 * 256.0 * 256.0),
                                   (256.0 * 256.0),
                                   256.0,
                                  1);
      return dot(value.abgr , bitShifts);
      
    }

    // convert 32 bit int to rgba
    ivec4 pack (int value) {

      ivec4 o = ivec4(0., 0., 0., 0.);

      o.w = (value / (256*256*256));
      o.z = ((value-o.w) / (256*256));
      o.y = ((value-o.w-o.z) / (256));
      o.x = (value-o.y*256-o.z*256*256-o.w*256*256*256);

      return o;

    }

    bool equals(float id1, float id2) {
      return (abs(id1-id2) <= 0.1);
    }

    bool larger(float id1, float id2) {

      if (equals(id1, id2)) return false;

      return id1 > id2;
    }

    float lookup_id(float id) {

      for (int m=0; m<MAX_MERGES; m++) {

        if (m>uMergeTableLength) return id;

        vec4 m_key = texture2D(uMergeTableKeySampler, vec2(float(m)/float(uMergeTableLength), 0.));
        float m_id = unpack(m_key)*255.;

        // if m_id is larger than our id, then we are done since all entries are sorted
        if (larger(m_id, id)) break;

        if (equals(id, m_id)) {
          // found entry
          vec4 m_value = texture2D(uMergeTableValueSampler, vec2(float(m)/float(uMergeTableLength), 0.));
          id = unpack(m_value)*255.;

          return id;
        }

      }

      return id;

    }

    void main() {

      // between 0..1
      vec4 tex1 = texture2D(uTextureSampler, vTexturePosition);

      float id = unpack(tex1)*255.;
      float orig_id = id;
      float new_id = id;

      //
      // MERGE
      //
      for (int m=0; m < 1000; m++) {

        new_id = lookup_id(id);

        if (equals(new_id, id)) {
          break;
        } else {
          id = new_id;
        }

      }


      bool border = false;
      if (uBorders == 1) {

        // grab surrounding ids
        float id_l = unpack(texture2D(uTextureSampler, vec2(vTexturePosition.x - 1.0/512.0, vTexturePosition.y)))*255.;
        float id_r = unpack(texture2D(uTextureSampler, vec2(vTexturePosition.x + 1.0/512.0, vTexturePosition.y)))*255.;
        float id_b = unpack(texture2D(uTextureSampler, vec2(vTexturePosition.x, vTexturePosition.y - 1.0/512.0)))*255.;
        float id_t = unpack(texture2D(uTextureSampler, vec2(vTexturePosition.x, vTexturePosition.y + 1.0/512.0)))*255.;

        border = ((!equals(id_l, orig_id) && !equals(id_l, new_id)) ||
                  (!equals(id_r, orig_id) && !equals(id_r, new_id)) ||
                  (!equals(id_b, orig_id) && !equals(id_b, new_id)) ||
                  (!equals(id_t, orig_id) && !equals(id_t, new_id)));
                   // !equals(id_r, id) || !equals(id_b, id) || !equals(id_t, id));
        // border = false;

      }

      float normalized_id = mod(id, uMaxColors);
      float orig_n_id = normalized_id;
      // float normalized_id = mod(id, 1.) + 33.; // <---- TESTCASE

      vec2 colormap_pos = vec2(normalized_id / (uMaxColors - 1.), 0.);
      
      vec4 color = texture2D(uColorMapSampler, colormap_pos);

      if (border) {

        gl_FragColor = vec4(0., 0., 0., 1.);

      } else {

        if (equals(uHighlightedId, id) || equals(uActivatedId, id)) {
           color.a = 0.8;
        } else {
          color.a = uOpacity/255.;
        }

        gl_FragColor = color;

        // gl_FragColor = vec4(tex1.x,tex1.y,tex1.z,1.0); // <<< shows the right id
        // ivec4 n = pack(int(old_id));
        // gl_FragColor = vec4(float(n.x)/255., float(n.y)/255., float(n.z)/255., 1.0);

      }

    }
  </script>

  <script id="vs1" type="x-shader/x-vertex">
    attribute vec3 aPosition;
    attribute vec2 aTexturePosition;

    varying vec3 vPosition;
    varying vec2 vTexturePosition;

    void main() {

      vTexturePosition = aTexturePosition;

      gl_Position = vec4(aPosition,1.);

    }

  </script>

  <script type="text/javascript">

  Opentip.defaultStyle = 'dark';
    
  window.onload = function() {

    DOJO.init();

  };

  </script>

</head>

<body>
  <div id='dojo1' class='viewer'></div>

  <div id='tools' class='toolbar'>
    <img src='gfx/merge.png' id='merge' class='tool' data-ot='Merge' data-ot-target='true' data-ot-tip-joint='right'>
    <img src='gfx/split.png' id='split' class='tool' data-ot='Split' data-ot-target='true' data-ot-tip-joint='right'>
    <img src='gfx/3d.png' id='3d' class='tool' data-ot='3D Rendering' data-ot-target='true' data-ot-tip-joint='right'>
  </div>

  <div id='info' class='infopanel'>
    <div><div id='slicenumber'>1/75</div><div id='label'>Label n/a</div></div>
    <div><strong>Q</strong>: next slice</div>
    <div><strong>A</strong>: previous slice</div>
  </div>

  <div id='log' class='logpanel'>
  </div>

</body>

</html>
