<html>
<head>

  <link rel="stylesheet" type="text/css" href="css/dojo.css">
  <link rel="stylesheet" type="text/css" href="css/opentip.css">

  <script type="text/javascript" src='lib/zlib.min.js'></script>
  <script type="text/javascript" src='lib/opentip-native.min.js'></script>

  <script type='text/javascript' src='dojo.js'></script>
  <script type='text/javascript' src='viewer.js'></script>
  <script type='text/javascript' src='controller.js'></script>
  <script type='text/javascript' src='camera.js'></script>
  <script type='text/javascript' src='interactor.js'></script>
  <script type='text/javascript' src='loader.js'></script>
  <script type='text/javascript' src='websocket.js'></script>
  <script type='text/javascript' src='offscreen_renderer.js'></script>
  <script type='text/javascript' src='util.js'></script>

  <!-- SHADERS -->
  <script id="fs1" type="x-shader/x-fragment">
    precision highp float;

    uniform sampler2D uTextureSampler;
    uniform sampler2D uColorMapSampler;
    //uniform sampler2D uTextureSampler2;
    uniform float uOpacity;
    uniform float uHighlightedId;
    uniform float uActivatedId;

    varying vec3 vPosition;
    varying vec2 vTexturePosition;

    float unpack (vec4 value) {
      // const vec4 bitShifts = vec4( (256.0 * 256.0 * 256.0),
      //                              (256.0 * 256.0),
      //                              256.0,
      //                             1);
      // return dot(colour.abgr , bitShifts);
      return value.x + value.y*256. + value.z*256.*256. + value.w*256.*256.*256.;
    }

    void main() {

      // [220, 11, 0, 0, 220, 11, 0, 0, ...
      vec4 tex1 = texture2D(uTextureSampler, vTexturePosition);

      float id = unpack(tex1);

      // gives 33
      //id = float(int(mod(id, 1.)) + 33);


      float normalized_id = float(int(mod(id, 1001.)));


// 3036 % 1001
// 33
// DOJO.viewer._colormap[3036 % 1001]
// [181, 134, 113]




      //[0, 0, 0, 255, 32, 48, 193, 255, 55, 86, 169, 255, 36, 163, 218, 255, 223, 115, 61, 255, 94, 79, 151, 255,
      //vec4 color = texture2D(uColorMapSampler, vTexturePosition);
    
      vec2 one_pixel = vec2(1.0, 1.0) / vec2(1001., 1.);

      vec2 colormap_pos = vec2(one_pixel.x * normalized_id, 0.);
      vec4 color = texture2D(uColorMapSampler, colormap_pos);
      //color = texture2D(uColorMapSampler, vec2(33, 0));


      if (id == uHighlightedId || id == uActivatedId) {
        color.a = 0.8;
      } else {
        color.a = uOpacity/255.;
      }

      //gl_FragColor = vec4(id/255., color.r, color.g, 0.);//vec4(color.rgb, 1.);
      //gl_FragColor = vec4(colormap_pos.x, vTexturePosition.x, 1. , 1.);
      gl_FragColor = color;

    }
  </script>

  <script id="vs1" type="x-shader/x-vertex">
    attribute vec3 aPosition;
    attribute vec2 aTexturePosition;

    varying vec3 vPosition;
    varying vec2 vTexturePosition;

    void main() {

      vTexturePosition = aTexturePosition;

      gl_Position = vec4(aPosition,1.);

    }

  </script>

  <script type="text/javascript">

  Opentip.defaultStyle = 'dark';
    
  window.onload = function() {

    DOJO.init();

  };

  </script>

</head>

<body>
  <div id='dojo1' class='viewer'></div>

  <div id='tools' class='toolbar'>
    <img src='gfx/merge.png' id='merge' class='tool' data-ot='Merge' data-ot-target='true' data-ot-tip-joint='right'>
    <img src='gfx/split.png' id='split' class='tool' data-ot='Split' data-ot-target='true' data-ot-tip-joint='right'>
    <img src='gfx/3d.png' id='3d' class='tool' data-ot='3D Rendering' data-ot-target='true' data-ot-tip-joint='right'>
  </div>

  <div id='info' class='infopanel'>
    <div><div id='slicenumber'>1/75</div><div id='label'>Label n/a</div></div>
    <div><strong>Q</strong>: next slice</div>
    <div><strong>A</strong>: previous slice</div>
  </div>

  <div id='log' class='logpanel'>
  </div>

</body>

</html>
